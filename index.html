<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover"/>
<title>D-Ai</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:         #f9f9f7;
  --white:      #ffffff;
  --surface:    #f2f2ef;
  --surface2:   #eaeae6;
  --border:     #e0e0d8;
  --border2:    #ccccc4;
  --text:       #111111;
  --text2:      #666660;
  --text3:      #aaa9a0;
  --accent:     #111111;
  --inv:        #ffffff;
  --blue:       #2563eb;
  --green:      #16a34a;
  --code-bg:    #f7f7f5;
  --radius:     14px;
  --sh-sm:      0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --sh-md:      0 4px 16px rgba(0,0,0,.08),0 2px 6px rgba(0,0,0,.04);
  --sh-lg:      0 12px 40px rgba(0,0,0,.10),0 4px 12px rgba(0,0,0,.06);
}

html {
  height: 100%;
  height: -webkit-fill-available;
}
body {
  height: 100%;
  height: -webkit-fill-available;
  overflow: hidden;
  background: var(--bg);
  font-family: 'DM Sans', sans-serif;
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  position: fixed; width: 100%;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#name-screen {
  position: fixed; inset: 0; z-index: 999;
  background: var(--white);
  display: flex; align-items: flex-start; justify-content: center;
  padding: 60px 16px 40px;
  overflow-y: auto;
  transition: opacity .5s ease, transform .5s ease;
}
@media (min-height: 600px) {
  #name-screen { align-items: center; padding: 20px 16px; }
}
#name-screen.leaving { opacity: 0; transform: translateY(-16px); pointer-events: none; }
#name-screen.gone    { display: none; }

.welcome-wrap {
  width: min(460px, 92vw);
  display: flex; flex-direction: column; align-items: center;
}

.welcome-logo {
  width: 76px; height: 76px;
  background: var(--accent); border-radius: 22px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 30px;
  box-shadow: var(--sh-lg);
}
.d-letter {
  font-family: 'Playfair Display', serif;
  font-weight: 700; color: var(--inv);
  display: inline-block;
  transform: rotate(12deg);
  line-height: 1; user-select: none;
}
.welcome-logo .d-letter { font-size: 2.6rem; }

.welcome-title {
  font-family: 'Playfair Display', serif;
  font-size: 2rem; font-weight: 700; letter-spacing: -.03em;
  text-align: center; margin-bottom: 10px;
}
.welcome-title em { font-style: italic; color: var(--text2); }

.welcome-sub {
  font-size: .88rem; color: var(--text2); text-align: center;
  line-height: 1.65; font-weight: 300; margin-bottom: 36px; max-width: 320px;
}

.name-form { width: 100%; display: flex; flex-direction: column; gap: 11px; }

.name-label {
  font-size: .72rem; font-weight: 600; letter-spacing: .09em;
  text-transform: uppercase; color: var(--text3);
  font-family: 'DM Mono', monospace;
}

.name-input-wrap input {
  width: 100%; background: var(--white);
  border: 1.5px solid var(--border); border-radius: 12px;
  padding: 14px 18px;
  font-family: 'DM Sans', sans-serif; font-size: 1rem;
  color: var(--text); outline: none;
  transition: border-color .2s, box-shadow .2s;
  box-shadow: var(--sh-sm);
}
.name-input-wrap input:focus { border-color: var(--border2); box-shadow: 0 0 0 3px rgba(0,0,0,.06); }
.name-input-wrap input::placeholder { color: var(--text3); }
.name-input-wrap input.error { border-color: #fca5a5; animation: shake .3s ease; }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

.name-btn {
  width: 100%; background: var(--accent); color: var(--inv);
  border: none; border-radius: 12px; padding: 14px;
  font-family: 'DM Sans', sans-serif; font-size: .92rem; font-weight: 600;
  cursor: pointer; letter-spacing: .01em;
  transition: opacity .2s, transform .15s, box-shadow .2s;
  box-shadow: 0 2px 12px rgba(0,0,0,.18);
}
.name-btn:hover  { opacity: .88; box-shadow: 0 4px 20px rgba(0,0,0,.22); }
.name-btn:active { transform: scale(.98); }

.name-note {
  font-size: .7rem; color: var(--text3); text-align: center;
  font-family: 'DM Mono', monospace; letter-spacing: .02em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#layout {
  display: flex;
  height: 100vh;
  height: 100dvh;
  height: -webkit-fill-available;
  overflow: hidden;
}

#chat-side {
  display: flex; flex-direction: column;
  flex: 1; min-width: 0; background: var(--white);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  display: flex; align-items: center; gap: 13px;
  padding: 0 20px; height: 60px;
  background: var(--white); border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.topbar-logo {
  width: 35px; height: 35px; background: var(--accent);
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; box-shadow: var(--sh-sm);
}
.topbar-logo .d-letter { font-size: 1.1rem; }
.topbar-info { flex: 1; }
.topbar-name   { font-weight: 600; font-size: .9rem; }
.topbar-status {
  font-size: .68rem; color: var(--green);
  font-family: 'DM Mono', monospace;
  display: flex; align-items: center; gap: 5px; margin-top: 1px;
}
.topbar-status::before {
  content: ''; width: 6px; height: 6px; border-radius: 50%;
  background: var(--green); display: inline-block;
}
.topbar-user {
  font-family: 'DM Mono', monospace; font-size: .68rem; color: var(--text3);
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; padding: 4px 12px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chat-area {
  flex: 1; overflow-y: auto;
  padding: 22px 20px;
  display: flex; flex-direction: column; gap: 6px;
  scroll-behavior: smooth; background: var(--white);
}
#chat-area::-webkit-scrollbar { width: 4px; }
#chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MESSAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.msg-row {
  display: flex; gap: 10px; max-width: 80%;
  animation: fadeUp .2s ease;
}
@keyframes fadeUp {
  from { transform: translateY(7px); opacity: 0; }
  to   { transform: translateY(0);   opacity: 1; }
}
.msg-row.me { align-self: flex-end;   flex-direction: row-reverse; }
.msg-row.ai { align-self: flex-start; }

.msg-av {
  width: 30px; height: 30px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: .62rem; font-weight: 700; flex-shrink: 0;
  align-self: flex-end; margin-bottom: 2px;
}
.msg-row.ai .msg-av { background: var(--accent); }
.msg-row.ai .msg-av .d-letter { font-size: .75rem; }
.msg-row.me .msg-av { background: var(--surface); border: 1px solid var(--border); color: var(--text2); font-family: 'DM Sans', sans-serif; }

.bubble {
  padding: 11px 15px; border-radius: var(--radius);
  font-size: .875rem; line-height: 1.7;
  word-break: break-word; max-width: 100%; position: relative;
}
.msg-row.me .bubble { background: var(--surface); border: 1px solid var(--border); border-bottom-right-radius: 4px; }
.msg-row.ai .bubble { background: var(--white); border: 1px solid var(--border); border-bottom-left-radius: 4px; box-shadow: var(--sh-sm); }

.bubble .sender-lbl {
  font-size: .61rem; color: var(--text3); letter-spacing: .07em;
  text-transform: uppercase; font-family: 'DM Mono', monospace;
  margin-bottom: 6px; display: block;
}
.bubble .ts {
  display: block; text-align: right;
  font-size: .61rem; color: var(--text3);
  margin-top: 7px; font-family: 'DM Mono', monospace;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MARKDOWN BODY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.md-body { font-size: .875rem; line-height: 1.75; color: var(--text); }
.md-body p { margin: 0 0 .7em; }
.md-body p:last-child { margin-bottom: 0; }
.md-body strong { font-weight: 700; color: #000; }
.md-body em { font-style: italic; font-family: 'Playfair Display', serif; font-size: 1em; color: var(--text2); }

.md-body h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.18em; font-weight: 700;
  margin: 1em 0 .35em; border-bottom: 1px solid var(--border); padding-bottom: 5px;
}
.md-body h2 { font-size: 1.02em; font-weight: 700; margin: .9em 0 .3em; }
.md-body h3 { font-size: .9em; font-weight: 600; margin: .75em 0 .25em; color: var(--text2); }

.md-body ul, .md-body ol {
  padding-left: 1.4em; margin: .3em 0 .7em;
  display: flex; flex-direction: column; gap: .22em;
}
.md-body li { line-height: 1.65; }
.md-body ul li::marker { color: var(--text3); }
.md-body ol li::marker { font-family: 'DM Mono', monospace; font-size: .8em; color: var(--text3); }
.md-body blockquote { border-left: 3px solid var(--border2); padding-left: 13px; margin: .6em 0; color: var(--text2); font-style: italic; }
.md-body hr { border: none; border-top: 1px solid var(--border); margin: .8em 0; }
.md-body a { color: var(--blue); text-decoration: none; }
.md-body a:hover { text-decoration: underline; }
.md-body table { width: 100%; border-collapse: collapse; margin: .6em 0; font-size: .83em; }
.md-body th, .md-body td { border: 1px solid var(--border); padding: 6px 11px; }
.md-body th { background: var(--surface); font-weight: 600; }

/* inline code */
.md-body code {
  background: var(--code-bg);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 1px 6px;
  font-family: 'DM Mono', monospace;
  font-size: .82em;
  color: var(--text);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE CARDS - SEPERTI DI SCREENSHOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.file-cards-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 12px 0;
}

.file-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
  gap: 12px;
}

.file-card-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
}

.file-icon {
  width: 40px;
  height: 40px;
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.file-details {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.file-name {
  font-family: 'DM Sans', sans-serif;
  font-size: .9rem;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-meta {
  font-family: 'DM Mono', monospace;
  font-size: .7rem;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: .02em;
}

.file-download-btn {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 16px;
  font-family: 'DM Sans', sans-serif;
  font-size: .8rem;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  transition: all .15s ease;
  white-space: nowrap;
  flex-shrink: 0;
}

.file-download-btn:hover {
  background: var(--accent);
  color: var(--inv);
  border-color: var(--accent);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL/CANVAS OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#code-modal {
  position: fixed;
  inset: 0;
  z-index: 1000;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(4px);
}

#code-modal.open {
  display: flex;
}

.code-modal-content {
  background: var(--white);
  border-radius: 16px;
  width: 100%;
  max-width: 800px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: var(--sh-lg);
}

.code-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}

.code-modal-title {
  font-family: 'DM Mono', monospace;
  font-size: .9rem;
  font-weight: 600;
  color: var(--text);
}

.code-modal-close {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: var(--white);
  border: 1px solid var(--border);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text2);
  font-size: 1rem;
  transition: all .15s;
}

.code-modal-close:hover {
  background: var(--accent);
  color: var(--inv);
  border-color: var(--accent);
}

.code-modal-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
}

.code-modal-tab {
  background: transparent;
  border: 1px solid transparent;
  border-radius: 6px;
  padding: 6px 14px;
  font-family: 'DM Mono', monospace;
  font-size: .72rem;
  color: var(--text3);
  cursor: pointer;
  transition: all .13s;
}

.code-modal-tab.active {
  background: var(--white);
  border-color: var(--border);
  color: var(--text);
}

.code-modal-action {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 12px;
  font-family: 'DM Mono', monospace;
  font-size: .72rem;
  color: var(--text2);
  cursor: pointer;
  transition: all .15s;
}

.code-modal-action:hover {
  background: var(--surface2);
}

.code-modal-body {
  flex: 1;
  overflow: auto;
  background: var(--code-bg);
}

#code-display {
  margin: 0;
  padding: 20px 24px;
  font-family: 'DM Mono', monospace;
  font-size: .85rem;
  line-height: 1.7;
  white-space: pre;
  overflow-x: auto;
  color: var(--text);
  tab-size: 2;
  min-height: 100%;
}

#code-preview {
  width: 100%;
  height: 100%;
  border: none;
  display: none;
  background: #fff;
}

/* comment spans */
.cc { color: #888; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TYPING INDICATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.typing-bubble { display: flex; gap: 5px; align-items: center; padding: 12px 16px; }
.typing-bubble span {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--text3); animation: tb 1.3s infinite;
}
.typing-bubble span:nth-child(2) { animation-delay: .17s; }
.typing-bubble span:nth-child(3) { animation-delay: .34s; }
@keyframes tb { 0%,80%,100%{transform:translateY(0);opacity:.4} 40%{transform:translateY(-5px);opacity:1} }

/* DIVIDER & SYSTEM */
.date-divider {
  text-align: center; font-size: .61rem; color: var(--text3);
  font-family: 'DM Mono', monospace; padding: 2px 0; position: relative; margin: 4px 0;
}
.date-divider::before, .date-divider::after {
  content: ''; position: absolute; top: 50%; width: 36%; height: 1px; background: var(--border);
}
.date-divider::before { left: 0; } .date-divider::after { right: 0; }

.sys-msg {
  align-self: center; font-size: .67rem; color: var(--text3);
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 20px; padding: 4px 14px;
  font-family: 'DM Mono', monospace; text-align: center; max-width: 90%; margin: 3px 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.input-area {
  padding: 13px 16px;
  padding-bottom: max(13px, env(safe-area-inset-bottom));
  background: var(--white);
  border-top: 1px solid var(--border);
  display: flex; align-items: flex-end; gap: 10px;
  flex-shrink: 0;
  position: sticky; bottom: 0;
  z-index: 10;
}
#msg-input {
  flex: 1; background: var(--surface);
  border: 1.5px solid var(--border); border-radius: 24px;
  padding: 11px 18px; color: var(--text);
  font-family: 'DM Sans', sans-serif; font-size: .9rem;
  resize: none; outline: none; max-height: 140px;
  overflow-y: auto; line-height: 1.55;
  transition: border-color .2s, box-shadow .2s, background .2s;
}
#msg-input:focus { border-color: var(--border2); background: var(--white); box-shadow: 0 0 0 3px rgba(0,0,0,.05); }
#msg-input::placeholder { color: var(--text3); }
#msg-input::-webkit-scrollbar { width: 3px; }
#msg-input:disabled { opacity: .5; cursor: not-allowed; }

#send-btn {
  width: 40px; height: 40px; background: var(--accent); border: none; border-radius: 50%;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: transform .15s, opacity .15s, box-shadow .15s;
  box-shadow: 0 2px 8px rgba(0,0,0,.18);
}
#send-btn:hover  { opacity: .85; box-shadow: 0 4px 14px rgba(0,0,0,.22); }
#send-btn:active { transform: scale(.93); }
#send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
#send-btn svg { width: 16px; height: 16px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 560px) {
  .msg-row { max-width: 94%; }
  .topbar, #chat-area, .input-area { padding-left: 14px; padding-right: 14px; }
  .code-modal-content {
    max-height: 95vh;
    border-radius: 12px;
  }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• NAME SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="name-screen">
  <div class="welcome-wrap">
    <div class="welcome-logo"><span class="d-letter">D</span></div>
    <h1 class="welcome-title">Selamat Datang di<br><em>D-Ai</em></h1>
    <p class="welcome-sub">AI yang cerdas dan bebas, siap membantu kamu kapanpun.<br>Perkenalkan namamu sebelum mulai.</p>
    <div class="name-form">
      <span class="name-label">Nama kamu</span>
      <div class="name-input-wrap">
        <input type="text" id="name-input" placeholder="Ketik namamu di sini..." maxlength="40" autocomplete="off"/>
      </div>
      <button class="name-btn" id="name-submit">Mulai Ngobrol â†’</button>
      <p class="name-note">Namamu disimpan lokal &amp; tidak bisa diubah setelahnya.</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layout">

  <!-- CHAT -->
  <div id="chat-side">
    <div class="topbar">
      <div class="topbar-logo"><span class="d-letter">D</span></div>
      <div class="topbar-info">
        <div class="topbar-name">D-Ai</div>
        <div class="topbar-status">online</div>
      </div>
      <div class="topbar-user" id="user-tag">â€”</div>
    </div>
    <div id="chat-area">
      <div class="date-divider">HARI INI</div>
    </div>
    <div class="input-area">
      <textarea id="msg-input" rows="1" placeholder="Tulis pesan kepada D-Ai..."></textarea>
      <button id="send-btn" title="Kirim">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• CODE MODAL/CANVAS â•â•â•â•â•â•â•â•â•â•â• -->
<div id="code-modal">
  <div class="code-modal-content">
    <div class="code-modal-header">
      <span class="code-modal-title" id="modal-filename">code.js</span>
      <button class="code-modal-close" onclick="closeCodeModal()">âœ•</button>
    </div>
    <div class="code-modal-toolbar">
      <button class="code-modal-tab active" id="modal-tab-code" onclick="switchModalTab('code')">Code</button>
      <button class="code-modal-tab" id="modal-tab-preview" onclick="switchModalTab('preview')">Preview</button>
      <button class="code-modal-action" onclick="copyModalCode()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2"/>
          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
        </svg>
        Copy
      </button>
    </div>
    <div class="code-modal-body">
      <pre id="code-display"></pre>
      <iframe id="code-preview" sandbox="allow-scripts"></iframe>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONFIGURASI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WORKER_URL          = "https://tight-dawn-e5d0.javas-muchie.workers.dev/";
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1476429779279286423/vXcv1FXigQeCE1Aw8vf0aiT4gp47GorDNdnIp2u1JCRKu6y8Bv8Y2LKUq25_kWcDu7nO";
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const STORAGE_KEY = "d_ai_username";
let username      = localStorage.getItem(STORAGE_KEY);
let isGenerating  = false;

// â”€â”€ NAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nameScreen = document.getElementById("name-screen");
const nameInput  = document.getElementById("name-input");
const nameBtn    = document.getElementById("name-submit");
const userTagEl  = document.getElementById("user-tag");

function applyUsername(name, animate) {
  username = name;
  userTagEl.textContent = name;
  if (animate) {
    nameScreen.classList.add("leaving");
    setTimeout(() => nameScreen.classList.add("gone"), 520);
  } else {
    nameScreen.classList.add("gone");
  }
  if (WORKER_URL.includes("GANTI-DENGAN")) {
    setTimeout(() => addSysMsg("âš ï¸ WORKER_URL belum diisi! Isi URL Cloudflare Worker kamu di bagian atas kode."), 700);
  }
}

if (username) {
  applyUsername(username, false);
} else {
  setTimeout(() => nameInput.focus(), 180);
}

nameBtn.addEventListener("click", saveName);
nameInput.addEventListener("keydown", e => { if (e.key === "Enter") saveName(); });

function saveName() {
  const val = nameInput.value.trim();
  if (!val) {
    nameInput.classList.add("error");
    setTimeout(() => nameInput.classList.remove("error"), 600);
    return;
  }
  localStorage.setItem(STORAGE_KEY, val);
  applyUsername(val, true);
  setTimeout(() => addSysMsg("Hai, " + val + "! Selamat datang di D-Ai ğŸ‘‹"), 600);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chatArea = document.getElementById("chat-area");
const msgInput = document.getElementById("msg-input");
const sendBtn  = document.getElementById("send-btn");

function nowStr() {
  return new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
}
function scrollBottom() { chatArea.scrollTop = chatArea.scrollHeight; }

function addSysMsg(text) {
  const el = document.createElement("div");
  el.className = "sys-msg"; el.textContent = text;
  chatArea.appendChild(el); scrollBottom();
}

function setGenerating(val) {
  isGenerating = val;
  msgInput.disabled = val;
  sendBtn.disabled  = val;
}

// â”€â”€ CODE STORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.__codeStore = window.__codeStore || {};
let __codeCounter = 0;

// â”€â”€ COMMENT COLORIZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function colorizeComments(code, lang) {
  const l = (lang || "").toLowerCase();
  const lines = code.split("\n");

  let lineComment  = null;
  let blockStart   = null;
  let blockEnd     = null;

  if (["javascript","js","typescript","ts","java","c","cpp","go","rust","css","swift","kotlin"].includes(l)) {
    lineComment = "//"; blockStart = "/*"; blockEnd = "*/";
  } else if (["python","py","bash","sh","ruby","rb","yaml","yml"].includes(l)) {
    lineComment = "#";
  } else if (["html","xml","svg"].includes(l)) {
    blockStart = "<!--"; blockEnd = "-->";
  } else if (["sql"].includes(l)) {
    lineComment = "--"; blockStart = "/*"; blockEnd = "*/";
  } else {
    return esc(code);
  }

  let result = "";
  let inBlock = false;

  for (let i = 0; i < lines.length; i++) {
    const raw = lines[i];
    const escaped = esc(raw);

    if (inBlock) {
      if (blockEnd && raw.includes(blockEnd)) {
        inBlock = false;
        result += "<span class=\"cc\">" + escaped + "</span>";
      } else {
        result += "<span class=\"cc\">" + escaped + "</span>";
      }
    } else if (blockStart && raw.trimStart().startsWith(blockStart)) {
      inBlock = !blockEnd || !raw.includes(blockEnd);
      result += "<span class=\"cc\">" + escaped + "</span>";
    } else if (lineComment && raw.trimStart().startsWith(lineComment)) {
      result += "<span class=\"cc\">" + escaped + "</span>";
    } else {
      if (lineComment) {
        const idx = findInlineComment(raw, lineComment);
        if (idx !== -1) {
          result += esc(raw.slice(0, idx)) + "<span class=\"cc\">" + esc(raw.slice(idx)) + "</span>";
        } else {
          result += escaped;
        }
      } else {
        result += escaped;
      }
    }
    if (i < lines.length - 1) result += "\n";
  }
  return result;
}

function esc(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function findInlineComment(line, marker) {
  let inStr = null;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (!inStr && (ch === '"' || ch === "'" || ch === '`')) { inStr = ch; continue; }
    if (inStr && ch === inStr && line[i-1] !== "\\") { inStr = null; continue; }
    if (!inStr && line.slice(i, i + marker.length) === marker) return i;
  }
  return -1;
}

// â”€â”€ FILE ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFileIcon(lang) {
  const l = (lang || "").toLowerCase();
  if (["javascript","js","typescript","ts"].includes(l)) return "ğŸ“„";
  if (["python","py"].includes(l)) return "ğŸ";
  if (["html","svg"].includes(l)) return "ğŸŒ";
  if (["css"].includes(l)) return "ğŸ¨";
  if (["java"].includes(l)) return "â˜•";
  if (["cpp","c"].includes(l)) return "âš™ï¸";
  if (["go"].includes(l)) return "ğŸ”µ";
  if (["rust","rs"].includes(l)) return "âš¡";
  if (["bash","sh"].includes(l)) return "ğŸ’»";
  if (["sql"].includes(l)) return "ğŸ—„ï¸";
  return "ğŸ“„";
}

function getFileExt(lang) {
  const l = (lang || "").toLowerCase();
  const map = {
    javascript: "js", js: "js", typescript: "ts", ts: "ts",
    python: "py", py: "py", html: "html", css: "css",
    java: "java", cpp: "cpp", c: "c", go: "go",
    rust: "rs", rs: "rs", bash: "sh", sh: "sh", sql: "sql"
  };
  return map[l] || l || "txt";
}

// â”€â”€ MARKDOWN RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(raw) {
  const blocks = [];
  let t = raw;

  // PERBAIKAN: Extract code blocks dengan cara yang lebih robust
  // Tangkap semua format: ```python, ```python\n, ```\npython, dll
  const codeBlockRegex = /```([a-zA-Z0-9_+-]*)\s*\n([\s\S]*?)```/g;
  let match;
  
  while ((match = codeBlockRegex.exec(raw)) !== null) {
    const lang = match[1].trim();
    const code = match[2];
    const fullMatch = match[0];
    const startIndex = match.index;
    
    const globalId = "cb_" + (++__codeCounter);
    const l = lang || "text";
    const trimmed = code.trimEnd();
    
    blocks.push({
      id: globalId,
      lang: l,
      code: trimmed,
      fullMatch: fullMatch,
      startIndex: startIndex,
      endIndex: startIndex + fullMatch.length
    });
    
    window.__codeStore[globalId] = { lang: l, code: trimmed };
  }

  // Jika tidak ada code block, proses sebagai markdown biasa
  if (blocks.length === 0) {
    return processBasicMarkdown(raw);
  }

  // Bangun hasil dengan mengganti code blocks
  let result = "";
  let lastIndex = 0;
  
  for (const block of blocks) {
    // Proses teks sebelum code block
    const textBefore = raw.slice(lastIndex, block.startIndex);
    result += processBasicMarkdown(textBefore);
    
    // Buat card untuk code block
    const lines = block.code.split('\n').length;
    const icon = getFileIcon(block.lang);
    const ext = getFileExt(block.lang);
    const filename = "code." + ext;
    
    result += '<div class="file-cards-container">' +
      '<div class="file-card">' +
        '<div class="file-card-info">' +
          '<div class="file-icon">' + icon + '</div>' +
          '<div class="file-details">' +
            '<div class="file-name">' + filename + '</div>' +
            '<div class="file-meta">' + block.lang + ' â€¢ ' + lines + ' baris</div>' +
          '</div>' +
        '</div>' +
        '<button class="file-download-btn" onclick="openCodeModal(\'' + block.id + '\')">Buka</button>' +
      '</div>' +
      '</div>';
    
    lastIndex = block.endIndex;
  }
  
  // Proses sisa teks setelah code block terakhir
  const textAfter = raw.slice(lastIndex);
  result += processBasicMarkdown(textAfter);
  
  return result;
}

// Fungsi terpisah untuk proses markdown dasar (tanpa code blocks)
function processBasicMarkdown(text) {
  if (!text) return "";
  
  let t = text;

  // Escape HTML
  t = t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

  // Headers
  t = t.replace(/^### (.+)$/gm, "<h3>$1</h3>");
  t = t.replace(/^## (.+)$/gm,  "<h2>$1</h2>");
  t = t.replace(/^# (.+)$/gm,   "<h1>$1</h1>");

  // Bold / italic
  t = t.replace(/\*\*\*(.+?)\*\*\*/g, "<strong><em>$1</em></strong>");
  t = t.replace(/\*\*(.+?)\*\*/g,     "<strong>$1</strong>");
  t = t.replace(/\*(.+?)\*/g,         "<em>$1</em>");
  t = t.replace(/_(.+?)_/g,           "<em>$1</em>");

  // HR
  t = t.replace(/^---+$/gm, "<hr>");

  // Blockquote
  t = t.replace(/^&gt; (.+)$/gm, "<blockquote>$1</blockquote>");

  // Unordered list
  t = t.replace(/((?:^[-*+] .+\n?)+)/gm, m => {
    const items = m.trim().split("\n").map(l => "<li>" + l.replace(/^[-*+] /,"") + "</li>").join("");
    return "<ul>" + items + "</ul>\n";
  });

  // Ordered list
  t = t.replace(/((?:^\d+\. .+\n?)+)/gm, m => {
    const items = m.trim().split("\n").map(l => "<li>" + l.replace(/^\d+\. /,"") + "</li>").join("");
    return "<ol>" + items + "</ol>\n";
  });

  // Inline code
  t = t.replace(/`([^`]+)`/g, "<code>$1</code>");

  // Links
  t = t.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>');

  // Paragraphs
  t = t.split("\n\n").map(block => {
    const tr = block.trim();
    if (!tr) return "";
    if (/^(<h[123]|<ul|<ol|<blockquote|<hr)/.test(tr)) return tr;
    return "<p>" + tr.replace(/\n/g,"<br>") + "</p>";
  }).join("\n");

  return t;
}

// â”€â”€ BUBBLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createBubble(role) {
  const row = document.createElement("div");
  row.className = "msg-row " + (role === "user" ? "me" : "ai");

  const av = document.createElement("div");
  av.className = "msg-av";
  if (role === "ai") {
    const d = document.createElement("span");
    d.className = "d-letter"; d.textContent = "D"; d.style.fontSize = ".75rem";
    av.appendChild(d);
  } else {
    av.textContent = username ? username[0].toUpperCase() : "U";
  }

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const lbl = document.createElement("span");
  lbl.className = "sender-lbl";
  lbl.textContent = role === "user" ? (username || "Kamu") : "D-Ai";
  bubble.appendChild(lbl);

  const content = document.createElement("div");
  content.className = role === "ai" ? "md-body" : "";
  bubble.appendChild(content);

  const ts = document.createElement("span");
  ts.className = "ts"; ts.textContent = nowStr();
  bubble.appendChild(ts);

  row.appendChild(av); row.appendChild(bubble);
  chatArea.appendChild(row); scrollBottom();
  return { row, content, ts };
}

function addUserBubble(text) {
  const { content } = createBubble("user");
  content.textContent = text;
}

function addAIBubble(text) {
  const { content } = createBubble("ai");
  content.innerHTML = renderMarkdown(text);
}

// â”€â”€ TYPING INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTyping() {
  const row = document.createElement("div");
  row.className = "msg-row ai"; row.id = "typing-row";
  const av = document.createElement("div"); av.className = "msg-av";
  const d = document.createElement("span"); d.className = "d-letter"; d.textContent = "D"; d.style.fontSize = ".75rem";
  av.appendChild(d);
  const bub = document.createElement("div"); bub.className = "bubble typing-bubble";
  bub.innerHTML = "<span></span><span></span><span></span>";
  row.appendChild(av); row.appendChild(bub);
  chatArea.appendChild(row); scrollBottom();
}

function removeTyping() {
  const el = document.getElementById("typing-row");
  if (el) el.remove();
}

async function askAI(userMsg) {
  const msgs = buildMessages(userMsg);
  showTyping();
  try {
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: msgs, max_tokens: 900, temperature: 0.7 })
    });
    const raw = await res.text();
    removeTyping();
    if (res.status === 401) return "âŒ Token tidak valid. Cek konfigurasi HF_TOKEN di Cloudflare Worker kamu.";
    if (res.status === 403) return "âŒ Akses ditolak. Permission token HF harus Read.";
    if (res.status === 429) return "âš ï¸ Rate limit. Tunggu sebentar lalu coba lagi.";
    if (!res.ok)            return "âŒ Error " + res.status + ": " + raw.slice(0, 300);
    let data;
    try { data = JSON.parse(raw); } catch { return "âŒ Respons tidak valid: " + raw.slice(0,200); }
    if (data.error) return "âŒ " + (typeof data.error === "string" ? data.error : JSON.stringify(data.error));
    return data.choices?.[0]?.message?.content?.trim() || "Tidak ada respons.";
  } catch (e) {
    removeTyping();
    if (e instanceof TypeError) return "âŒ CORS Error: Buka via Live Server, bukan double-click file HTML.";
    return "âŒ " + e.message;
  }
}

// â”€â”€ CONVERSATION HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const history = [];

function buildMessages(userMsg) {
  history.push({ role: "user", content: userMsg });
  return [
    {
      role: "system",
      content:
        "Kamu adalah D-Ai, AI chat yang cerdas, jujur, dan bebas. " +
        "Nama pengguna yang chat denganmu adalah \"" + (username || "pengguna") + "\". " +
        "Jawab dalam bahasa yang sama dengan pengguna. Tidak ada batasan topik.\n\n" +
        "Identitasmu: Kamu bernama D-Ai. Model AI yang menjalankanmu adalah GLM-5. " +
        "Kamu diintegrasikan dan dipasang ke website ini oleh seseorang bernama Danis. " +
        "Kalau ada yang bertanya siapa yang buat kamu, model apa kamu, dsb â€” jawab dengan bangga: " +
        "kamu adalah D-Ai, ditenagai model GLM-5, dan website ini dibangun oleh Danis.\n\n" +
        "Format respons dengan Markdown: **bold** untuk poin penting, ## untuk heading, " +
        "list untuk langkah-langkah, dan fenced code block dengan nama bahasa (```python, ```js, dll) " +
        "untuk SEMUA kode. Tulis ringkas dan padat, hindari bertele-tele."
    },
    ...history
  ];
}

// â”€â”€ DISCORD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendToDiscord(userMsg, aiReply) {
  if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL.includes("XXX/XXX")) return;
  try {
    await fetch(DISCORD_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        content: "**[D-Ai Log]**\nğŸ‘¤ **" + (username||"?") + "** : " + userMsg +
                 "\nğŸ¤– **D-Ai** : " + aiReply.slice(0, 1800)
      })
    });
  } catch(e) { console.warn("Discord:", e); }
}

// â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text || !username || isGenerating) return;

  msgInput.value = "";
  msgInput.style.height = "auto";
  setGenerating(true);

  addUserBubble(text);

  const aiReply = await askAI(text);
  history.push({ role: "assistant", content: aiReply });
  addAIBubble(aiReply);

  setGenerating(false);
  sendToDiscord(text, aiReply);
}

sendBtn.addEventListener("click", sendMessage);
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 140) + "px";
});

// â”€â”€ MOBILE VIEWPORT FIX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fixViewport() {
  const layout = document.getElementById("layout");
  if (window.visualViewport) {
    window.visualViewport.addEventListener("resize", () => {
      const h = window.visualViewport.height;
      layout.style.height = h + "px";
      document.body.style.height = h + "px";
      scrollBottom();
    });
    window.visualViewport.addEventListener("scroll", scrollBottom);
  } else {
    window.addEventListener("resize", () => {
      layout.style.height = window.innerHeight + "px";
      scrollBottom();
    });
  }
}
fixViewport();

// â”€â”€ CODE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const codeModal = document.getElementById("code-modal");
const modalFilename = document.getElementById("modal-filename");
const codeDisplay = document.getElementById("code-display");
const codePreview = document.getElementById("code-preview");
let currentModalCode = "";
let currentModalLang = "";

function openCodeModal(globalId) {
  const block = window.__codeStore[globalId];
  if (!block) return;
  
  currentModalCode = block.code;
  currentModalLang = block.lang;
  
  const ext = getFileExt(block.lang);
  modalFilename.textContent = "code." + ext;
  
  // Render code with comment coloring
  codeDisplay.innerHTML = colorizeComments(block.code, block.lang);
  
  // Show/hide preview tab for HTML
  const isPreviewable = ["html","svg"].includes(block.lang.toLowerCase());
  document.getElementById("modal-tab-preview").style.display = isPreviewable ? "" : "none";
  
  switchModalTab("code");
  codeModal.classList.add("open");
  document.body.style.overflow = "hidden";
}

function closeCodeModal() {
  codeModal.classList.remove("open");
  document.body.style.overflow = "";
  codePreview.srcdoc = "";
}

function switchModalTab(tab) {
  document.getElementById("modal-tab-code").classList.toggle("active", tab === "code");
  document.getElementById("modal-tab-preview").classList.toggle("active", tab === "preview");
  
  if (tab === "code") {
    codeDisplay.style.display = "";
    codePreview.style.display = "none";
  } else {
    codeDisplay.style.display = "none";
    codePreview.style.display = "";
    codePreview.srcdoc = currentModalCode;
  }
}

function copyModalCode() {
  navigator.clipboard.writeText(currentModalCode).then(() => {
    const btn = document.querySelector(".code-modal-action");
    const original = btn.innerHTML;
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Tersalin!';
    btn.style.color = "var(--green)";
    setTimeout(() => {
      btn.innerHTML = original;
      btn.style.color = "";
    }, 2000);
  });
}

// Close modal on backdrop click
codeModal.addEventListener("click", (e) => {
  if (e.target === codeModal) closeCodeModal();
});

// Close on Escape key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && codeModal.classList.contains("open")) {
    closeCodeModal();
  }
});
</script>
</body>
</html>
